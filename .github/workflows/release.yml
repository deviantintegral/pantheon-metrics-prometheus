name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to release (e.g., v1.0.0)'
        required: true
        type: string

permissions:
  contents: write
  packages: write

jobs:
  goreleaser:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          ref: ${{ github.event.inputs.tag || github.ref }}

      - name: Set up Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6
        with:
          go-version: '1.24.7'
          cache: true

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@e435ccd777264be153ace6237001ef4d979d3a7a # v6
        with:
          distribution: goreleaser
          version: '~> v2'
          args: release --clean --skip=docker
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload dist artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: dist
          path: dist/
          retention-days: 1

  docker:
    needs: goreleaser
    strategy:
      matrix:
        include:
          - runner: ubuntu-24.04
            platform: linux/amd64
            arch: amd64
            dist_path: default_linux_amd64_v1
          - runner: ubuntu-24.04-arm
            platform: linux/arm64
            arch: arm64
            dist_path: default_linux_arm64
    runs-on: ${{ matrix.runner }}
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          ref: ${{ github.event.inputs.tag || github.ref }}

      - name: Get version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          if [ -n "${{ github.event.inputs.tag }}" ]; then
            VERSION=${{ github.event.inputs.tag }}
            VERSION=${VERSION#v}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Download dist artifacts
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          name: dist
          path: dist

      - name: Prepare binary
        run: |
          cp "dist/${{ matrix.dist_path }}/pantheon-metrics-exporter" ./pantheon-metrics-exporter
          chmod +x ./pantheon-metrics-exporter

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@b5ca514318bd6ebac0fb2aedd5d36ec1b5c232a2 # v3

      - name: Login to GHCR
        uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772 # v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@14487ce63c7a62a4a324b0bfb37086795e31c6c1 # v6
        with:
          context: .
          file: Dockerfile.goreleaser
          platforms: ${{ matrix.platform }}
          push: true
          tags: |
            ghcr.io/deviantintegral/pantheon-metrics-prometheus:${{ steps.version.outputs.version }}-${{ matrix.arch }}
            ghcr.io/deviantintegral/pantheon-metrics-prometheus:latest-${{ matrix.arch }}
          labels: |
            org.opencontainers.image.source=https://github.com/deviantintegral/pantheon-metrics-prometheus
            org.opencontainers.image.version=${{ steps.version.outputs.version }}
            org.opencontainers.image.title=pantheon-metrics-prometheus
            org.opencontainers.image.description=Prometheus exporter for Pantheon hosting metrics

  docker-manifest:
    needs: docker
    runs-on: ubuntu-24.04
    steps:
      - name: Get version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          if [ -n "${{ github.event.inputs.tag }}" ]; then
            VERSION=${{ github.event.inputs.tag }}
            VERSION=${VERSION#v}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Login to GHCR
        uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772 # v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create and push multi-arch manifest
        run: |
          VERSION=${{ steps.version.outputs.version }}

          # Create versioned manifest
          docker manifest create ghcr.io/deviantintegral/pantheon-metrics-prometheus:${VERSION} \
            ghcr.io/deviantintegral/pantheon-metrics-prometheus:${VERSION}-amd64 \
            ghcr.io/deviantintegral/pantheon-metrics-prometheus:${VERSION}-arm64
          docker manifest push ghcr.io/deviantintegral/pantheon-metrics-prometheus:${VERSION}

          # Create latest manifest
          docker manifest create ghcr.io/deviantintegral/pantheon-metrics-prometheus:latest \
            ghcr.io/deviantintegral/pantheon-metrics-prometheus:latest-amd64 \
            ghcr.io/deviantintegral/pantheon-metrics-prometheus:latest-arm64
          docker manifest push ghcr.io/deviantintegral/pantheon-metrics-prometheus:latest
