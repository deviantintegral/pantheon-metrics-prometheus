name: Build and Release

on:
  workflow_call:
    inputs:
      publish:
        description: 'Publish to GitHub releases and push Docker images'
        required: true
        type: boolean
      version:
        description: 'Version tag (e.g., v1.0.0). If empty, uses snapshot versioning.'
        required: false
        type: string
        default: ''

jobs:
  goreleaser:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6
        with:
          go-version: '1.24.7'
          cache: true

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@e435ccd777264be153ace6237001ef4d979d3a7a # v6
        with:
          distribution: goreleaser
          version: '~> v2'
          args: ${{ inputs.publish && 'release --clean --skip=docker' || 'build --snapshot --clean' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload dist artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: dist
          path: dist/
          retention-days: ${{ inputs.publish && 1 || 7 }}

  docker:
    needs: goreleaser
    strategy:
      matrix:
        include:
          - runner: ubuntu-24.04
            platform: linux/amd64
            arch: amd64
          - runner: ubuntu-24.04-arm
            platform: linux/arm64
            arch: arm64
    runs-on: ${{ matrix.runner }}
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Download dist artifacts
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          name: dist
          path: dist

      - name: Prepare binary
        run: |
          # Find the binary for this architecture
          BINARY=$(find dist -name "pantheon-metrics-exporter" -path "*linux_${{ matrix.arch }}*" -type f | head -1)
          if [ -z "$BINARY" ]; then
            echo "Error: Could not find binary for linux/${{ matrix.arch }}"
            echo "Available files in dist:"
            find dist -type f -name "pantheon-metrics-exporter"
            exit 1
          fi
          echo "Found binary: $BINARY"
          cp "$BINARY" ./pantheon-metrics-exporter
          chmod +x ./pantheon-metrics-exporter

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@b5ca514318bd6ebac0fb2aedd5d36ec1b5c232a2 # v3

      - name: Login to GHCR
        if: inputs.publish
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine image tags
        id: tags
        run: |
          VERSION="${{ inputs.version }}"
          VERSION="${VERSION#v}"  # Strip leading 'v' if present
          if [ -z "$VERSION" ]; then
            VERSION="dev-$(git rev-parse --short HEAD)"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        uses: docker/build-push-action@14487ce63c7a62a4a324b0bfb37086795e31c6c1 # v6
        with:
          context: .
          file: Dockerfile.goreleaser
          platforms: ${{ matrix.platform }}
          push: ${{ inputs.publish }}
          tags: |
            ghcr.io/deviantintegral/pantheon-metrics-prometheus:${{ steps.tags.outputs.version }}-${{ matrix.arch }}
            ${{ inputs.publish && format('ghcr.io/deviantintegral/pantheon-metrics-prometheus:latest-{0}', matrix.arch) || '' }}
          labels: |
            org.opencontainers.image.source=https://github.com/deviantintegral/pantheon-metrics-prometheus
            org.opencontainers.image.version=${{ steps.tags.outputs.version }}
            org.opencontainers.image.title=pantheon-metrics-prometheus
            org.opencontainers.image.description=Prometheus exporter for Pantheon hosting metrics

  docker-manifest:
    if: inputs.publish
    needs: docker
    runs-on: ubuntu-24.04
    steps:
      - name: Determine version
        id: version
        run: |
          VERSION="${{ inputs.version }}"
          VERSION="${VERSION#v}"  # Strip leading 'v' if present
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Login to GHCR
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create and push multi-arch manifest
        run: |
          VERSION=${{ steps.version.outputs.version }}

          # Create versioned manifest
          docker manifest create ghcr.io/deviantintegral/pantheon-metrics-prometheus:${VERSION} \
            ghcr.io/deviantintegral/pantheon-metrics-prometheus:${VERSION}-amd64 \
            ghcr.io/deviantintegral/pantheon-metrics-prometheus:${VERSION}-arm64
          docker manifest push ghcr.io/deviantintegral/pantheon-metrics-prometheus:${VERSION}

          # Create latest manifest
          docker manifest create ghcr.io/deviantintegral/pantheon-metrics-prometheus:latest \
            ghcr.io/deviantintegral/pantheon-metrics-prometheus:latest-amd64 \
            ghcr.io/deviantintegral/pantheon-metrics-prometheus:latest-arm64
          docker manifest push ghcr.io/deviantintegral/pantheon-metrics-prometheus:latest
