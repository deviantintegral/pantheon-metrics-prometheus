name: Build and Release

on:
  workflow_call:
    inputs:
      publish:
        description: 'Publish to GitHub releases and push Docker images'
        required: true
        type: boolean
      version:
        description: 'Version tag (e.g., v1.0.0). If empty, uses snapshot versioning.'
        required: false
        type: string
        default: ''

jobs:
  goreleaser:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6
        with:
          go-version: '1.24.7'
          cache: true

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@e435ccd777264be153ace6237001ef4d979d3a7a # v6
        with:
          distribution: goreleaser
          version: '~> v2'
          args: ${{ inputs.publish && 'release --clean --skip=docker' || 'build --snapshot --clean' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload dist artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: dist
          path: dist/
          retention-days: ${{ inputs.publish && 1 || 7 }}

  docker:
    needs: goreleaser
    strategy:
      matrix:
        include:
          - runner: ubuntu-24.04
            platform: linux/amd64
            arch: amd64
          - runner: ubuntu-24.04-arm
            platform: linux/arm64
            arch: arm64
    runs-on: ${{ matrix.runner }}
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Download dist artifacts
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
        with:
          name: dist
          path: dist

      - name: Prepare binary
        run: |
          # Find the binary for this architecture
          BINARY=$(find dist -name "pantheon-metrics-exporter" -path "*linux_${{ matrix.arch }}*" -type f | head -1)
          if [ -z "$BINARY" ]; then
            echo "Error: Could not find binary for linux/${{ matrix.arch }}"
            echo "Available files in dist:"
            find dist -type f -name "pantheon-metrics-exporter"
            exit 1
          fi
          echo "Found binary: $BINARY"
          cp "$BINARY" ./pantheon-metrics-exporter
          chmod +x ./pantheon-metrics-exporter

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3

      - name: Login to GHCR
        if: inputs.publish
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine image tags
        id: tags
        run: |
          VERSION="${{ inputs.version }}"
          VERSION="${VERSION#v}"  # Strip leading 'v' if present
          if [ -z "$VERSION" ]; then
            VERSION="dev-$(git rev-parse --short HEAD)"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        uses: docker/build-push-action@ee4ca427a2f43b6a16632044ca514c076267da23 # v6
        with:
          context: .
          file: Dockerfile.goreleaser
          platforms: ${{ matrix.platform }}
          push: ${{ inputs.publish }}
          # Disable provenance to ensure single-platform images are pushed as
          # regular images, not manifest lists. This is required for the
          # docker-manifest job to combine them into a multi-arch manifest.
          provenance: false
          tags: |
            ghcr.io/deviantintegral/pantheon-metrics-prometheus:${{ steps.tags.outputs.version }}-${{ matrix.arch }}
            ${{ inputs.publish && format('ghcr.io/deviantintegral/pantheon-metrics-prometheus:latest-{0}', matrix.arch) || '' }}
          labels: |
            org.opencontainers.image.source=https://github.com/deviantintegral/pantheon-metrics-prometheus
            org.opencontainers.image.version=${{ steps.tags.outputs.version }}
            org.opencontainers.image.title=pantheon-metrics-prometheus
            org.opencontainers.image.description=Prometheus exporter for Pantheon hosting metrics

  docker-manifest:
    if: inputs.publish
    needs: docker
    runs-on: ubuntu-24.04
    steps:
      - name: Determine version
        id: version
        run: |
          VERSION="${{ inputs.version }}"
          VERSION="${VERSION#v}"  # Strip leading 'v' if present
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3

      - name: Login to GHCR
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create and push multi-arch manifest
        run: |
          VERSION=${{ steps.version.outputs.version }}

          # Create versioned manifest using buildx imagetools, which properly
          # handles images with provenance attestations (manifest lists)
          docker buildx imagetools create -t ghcr.io/deviantintegral/pantheon-metrics-prometheus:${VERSION} \
            ghcr.io/deviantintegral/pantheon-metrics-prometheus:${VERSION}-amd64 \
            ghcr.io/deviantintegral/pantheon-metrics-prometheus:${VERSION}-arm64

          # Create latest manifest
          docker buildx imagetools create -t ghcr.io/deviantintegral/pantheon-metrics-prometheus:latest \
            ghcr.io/deviantintegral/pantheon-metrics-prometheus:latest-amd64 \
            ghcr.io/deviantintegral/pantheon-metrics-prometheus:latest-arm64
